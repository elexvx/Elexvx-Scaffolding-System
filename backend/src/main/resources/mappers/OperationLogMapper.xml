<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tencent.tdesign.mapper.OperationLogMapper">
  <sql id="BaseSelect">
    SELECT id,
      action,
      module,
      detail,
      user_id,
      user_guid,
      account,
      ip_address,
      device_model,
      os,
      browser,
      created_at
    FROM operation_logs
  </sql>

  <sql id="FilterWhere">
    <where>
      <if test="userId != null">
        AND user_id = #{userId}
      </if>
      <if test="action != null and action != ''">
        AND action = #{action}
      </if>
      <if test="startTime != null">
        AND created_at <![CDATA[>=]]> #{startTime}
      </if>
      <if test="endTime != null">
        AND created_at <![CDATA[<=]]> #{endTime}
      </if>
      <if test="keyword != null and keyword != ''">
        AND (
          account LIKE CONCAT(CONCAT('%', #{keyword}), '%')
          OR user_guid LIKE CONCAT(CONCAT('%', #{keyword}), '%')
          OR module LIKE CONCAT(CONCAT('%', #{keyword}), '%')
          OR detail LIKE CONCAT(CONCAT('%', #{keyword}), '%')
          OR ip_address LIKE CONCAT(CONCAT('%', #{keyword}), '%')
          OR device_model LIKE CONCAT(CONCAT('%', #{keyword}), '%')
          OR os LIKE CONCAT(CONCAT('%', #{keyword}), '%')
          OR browser LIKE CONCAT(CONCAT('%', #{keyword}), '%')
        )
      </if>
    </where>
  </sql>

  <select id="selectPage" resultType="com.tencent.tdesign.entity.OperationLogEntity">
    <include refid="BaseSelect" />
    <include refid="FilterWhere" />
    ORDER BY id DESC
    <choose>
      <when test="_databaseId == 'oracle' or _databaseId == 'sqlserver'">
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
      </when>
      <otherwise>
        LIMIT #{limit} OFFSET #{offset}
      </otherwise>
    </choose>
  </select>

  <select id="selectAll" resultType="com.tencent.tdesign.entity.OperationLogEntity">
    <include refid="BaseSelect" />
    <include refid="FilterWhere" />
    ORDER BY id DESC
  </select>

  <select id="count" resultType="long">
    SELECT COUNT(1)
    FROM operation_logs
    <include refid="FilterWhere" />
  </select>

  <insert id="insert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO operation_logs (
      action,
      module,
      detail,
      user_id,
      user_guid,
      account,
      ip_address,
      device_model,
      os,
      browser,
      created_at
    )
    VALUES (
      #{action},
      #{module},
      #{detail},
      #{userId},
      #{userGuid},
      #{account},
      #{ipAddress},
      #{deviceModel},
      #{os},
      #{browser},
      #{createdAt}
    )
  </insert>

  <delete id="deleteBefore">
    DELETE FROM operation_logs
    WHERE created_at <![CDATA[<]]> #{threshold}
  </delete>
</mapper>
